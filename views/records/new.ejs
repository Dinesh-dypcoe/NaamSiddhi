<% layout('./layout/boilerplate') -%>

<style>
    .required-field::placeholder {
        background: linear-gradient(to right, 
            #9ca3af 0%, 
            #9ca3af calc(100% - 8px), 
            #ef4444 calc(100% - 8px), 
            #ef4444 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .required-select {
        color: #9ca3af;
    }
    .required-select option:first-child {
        background: linear-gradient(to right, 
            #9ca3af 0%, 
            #9ca3af calc(100% - 8px), 
            #ef4444 calc(100% - 8px), 
            #ef4444 100%);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }
</style>

<div class="pt-20">
    <div class="glass-effect rounded-lg p-8 max-w-4xl mx-auto">
        <h1 class="text-3xl font-nasa text-center mb-8 text-blue-400">Create Profile</h1>

        <form action="/newrecord" method="POST" enctype="multipart/form-data" class="space-y-8">
            <div class="mb-6 text-sm text-red-400">
                Fields marked with * are required
            </div>

            <!-- Personal Information Section -->
            <div class="space-y-6">
                <h2 class="text-xl font-nasa text-blue-400/80">Personal Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Name Fields -->
                    <div class="space-y-2">
                        <input type="text" 
                               name="firstName" 
                               placeholder="First Name / पहला नाम *" 
                               required
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-field">
                    </div>
                    <div class="space-y-2">
                        <input type="text" 
                               name="middleName" 
                               placeholder="Middle Name / मध्य नाम"
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
                    </div>
                    <div class="space-y-2">
                        <input type="text" 
                               name="lastName" 
                               placeholder="Last Name / अंतिम नाम *" 
                               required
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-field">
                    </div>

                    <!-- Occupation & DOB -->
                    <div class="space-y-2">
                        <input type="text" 
                               name="occupation" 
                               placeholder="Occupation / पेशा"
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
                    </div>
                    <div class="space-y-2 relative">
                        <input type="text" 
                               name="dob" 
                               required
                               placeholder="Date of Birth / जन्म तिथि *"
                               onfocus="(this.type='date');this.showPicker()"
                               onblur="if(!this.value) this.type='text'"
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 [&::-webkit-calendar-picker-indicator]:opacity-0 required-field">
                    </div>

                    <!-- Gender & Phone -->
                    <div class="space-y-2">
                        <select name="gender" 
                                required
                                class="w-full h-[42px] bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-select">
                            <option value="" disabled selected>Select Gender / लिंग *</option>
                            <option value="male">Male / पुरुष</option>
                            <option value="female">Female / महिला</option>
                            <option value="other">Others / अन्य</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <input type="tel" 
                               name="mNumber" 
                               id="mobileNumber"
                               placeholder="Phone Number / फ़ोन नंबर *"
                               pattern="[0-9]{10}"
                               required
                               oninput="validateMobile(this)"
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-field">
                    </div>
                </div>
            </div>

            <!-- Address Section -->
            <div class="space-y-6">
                <h2 class="text-xl font-nasa text-blue-400/80">Address Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <input type="text" 
                               name="address[location]" 
                               placeholder="Location / स्थान *" 
                               required
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-field">
                    </div>
                    <div class="space-y-2">
                        <input type="text" 
                               name="address[city]" 
                               placeholder="City / शहर *" 
                               required
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-field">
                    </div>
                    <div class="space-y-2">
                        <input type="text" 
                               name="address[district]" 
                               placeholder="District / जिला *" 
                               required
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-field">
                    </div>
                    <div class="space-y-2">
                        <input type="text" 
                               name="address[state]" 
                               placeholder="State / राज्य *" 
                               required
                               class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100 required-field">
                    </div>
                </div>
            </div>

            <!-- Family Details Section -->
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-nasa text-blue-400/80">Family Details</h2>
                    <button type="button" 
                            id="toggleFamilyDetails"
                            class="bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 font-nasa px-4 py-2 rounded-md transition-all flex items-center">
                        <svg class="w-4 h-4 mr-2 transform transition-transform" id="familyIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Add Family Details
                    </button>
                </div>
                <div id="familyDetailsContainer" class="hidden space-y-4">
                    <div id="familyMembers" class="space-y-4">
                        <!-- Family member entries will be added here -->
                    </div>
                    <button type="button" 
                            onclick="addFamilyMember()"
                            class="bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 font-nasa px-4 py-2 rounded-md transition-all">
                        + Add Another Family Member
                    </button>
                </div>
            </div>

            <!-- Appearance Details / उपस्थिति विवरण -->
            <div class="space-y-6">
                <h2 class="text-xl font-nasa text-blue-400/80">Appearance Details / उपस्थिति विवरण</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Physical Characteristics -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-nasa text-blue-400/60">Physical Characteristics / शारीरिक विशेषताएं</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" 
                                       name="appearance[height]" 
                                       placeholder="Height (cm) / ऊचाई"
                                       class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
                                
                                <input type="number" 
                                       name="appearance[weight]" 
                                       placeholder="Weight (kg) / वजन"
                                       class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
                            </div>
                            
                            <select name="appearance[complexion]"
                                    class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
                                <option value="" disabled selected>Complexion / रंग</option>
                                <option value="fair">Fair / गोरा</option>
                                <option value="medium">Medium / साँवला</option>
                                <option value="dark">Dark / काला</option>
                            </select>

                            <select name="appearance[build]"
                                    class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
                                <option value="" disabled selected>Build / शारीरिक बनावट</option>
                                <option value="slim">Slim / पतला</option>
                                <option value="average">Average / सामान्य</option>
                                <option value="athletic">Athletic / एथलेटिक</option>
                                <option value="heavy">Heavy / भारी</option>
                            </select>
                        </div>
                    </div>

                    <!-- Distinguishing Features -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-nasa text-blue-400/60">Distinguishing Features / विशेष पहचान</h3>
                        <div class="space-y-4">
                            <input type="text" 
                                   name="appearance[facialFeatures]" 
                                   placeholder="Facial Features / चेहरे की विशेषताएं"
                                   class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">

                            <input type="text" 
                                   name="appearance[scars]" 
                                   placeholder="Scars/Marks / निशान"
                                   class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">

                            <input type="text" 
                                   name="appearance[tattoos]" 
                                   placeholder="Tattoos / टैटू"
                                   class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">

                            <textarea name="appearance[otherFeatures]" 
                                    placeholder="Other Distinguishing Features / अन्य विशेष पहचान"
                                    rows="2"
                                    class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Images Section -->
            <div class="space-y-6">
                <h2 class="text-xl font-nasa text-blue-400/80">Profile Images</h2>
                <div class="space-y-4">
                    <!-- Profile Photo -->
                    <div>
                        <label class="block text-gray-400 mb-2">Profile Photo</label>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="file" 
                                       name="profileImage" 
                                       accept="image/*"
                                       class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                       onchange="previewImage(this, 'profilePreview')">
                                <div class="bg-space-dark/50 border-2 border-dashed border-blue-400/30 rounded-lg p-4 text-center">
                                    <img id="profilePreview" src="" alt="" class="mx-auto max-h-40 hidden">
                                    <div id="profilePlaceholder" class="text-gray-400">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="mt-1">Click to upload profile photo</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ID Proof -->
                    <div>
                        <label class="block text-gray-400 mb-2">ID Proof</label>
                        <div class="flex items-center space-x-4">
                            <div class="relative">
                                <input type="file" 
                                       name="idProof" 
                                       accept="image/*"
                                       class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                       onchange="previewImage(this, 'idPreview')">
                                <div class="bg-space-dark/50 border-2 border-dashed border-blue-400/30 rounded-lg p-4 text-center">
                                    <img id="idPreview" src="" alt="" class="mx-auto max-h-40 hidden">
                                    <div id="idPlaceholder" class="text-gray-400">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <p class="mt-1">Click to upload ID proof</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center pt-6">
                <button type="submit" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-nasa px-8 py-3 rounded-md transition-all transform hover:scale-105 hover:shadow-lg hover:shadow-blue-500/20">
                    Submit Profile / प्रोफ़ाइल सबमिट करें
                </button>
            </div>
        </form>
    </div>
</div>

<script src="/js/suggestions.js"></script>
<script>
    // Toggle sections
    document.getElementById('toggleFamilyDetails').addEventListener('click', function() {
        const container = document.getElementById('familyDetailsContainer');
        const icon = document.getElementById('familyIcon');
        container.classList.toggle('hidden');
        icon.style.transform = container.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(45deg)';
        if (!container.classList.contains('hidden') && container.children.length === 1) {
            addFamilyMember();
        }
    });

    // Add family member entry
    function addFamilyMember() {
        const container = document.getElementById('familyMembers');
        const memberDiv = document.createElement('div');
        memberDiv.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 p-4 glass-effect rounded-lg';
        memberDiv.innerHTML = `
            <input type="text" 
                   name="familyDetails[name][]" 
                   placeholder="Name / नाम"
                   class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
            <input type="text" 
                   name="familyDetails[relation][]" 
                   placeholder="Relation / रिश्ता"
                   class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
            <div class="flex items-center space-x-2">
                <input type="text" 
                       name="familyDetails[contact][]" 
                       placeholder="Contact / संपर्क"
                       class="w-full bg-space-dark/50 border border-blue-400/30 rounded-md px-4 py-2 focus:outline-none focus:border-blue-400 transition-all text-gray-100">
                <button type="button" 
                        onclick="this.parentElement.parentElement.remove()"
                        class="bg-red-500/20 hover:bg-red-500/30 text-red-400 p-2 rounded-md transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
        container.appendChild(memberDiv);
    }

    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const placeholder = document.getElementById(previewId.replace('Preview', 'Placeholder'));
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    function validateAadhar(input) {
        const feedback = document.getElementById('aadharFeedback');
        const value = input.value.replace(/\D/g, ''); // Remove non-digits
        input.value = value; // Update input to show only digits

        if (value.length === 0) {
            feedback.classList.add('hidden');
            input.classList.remove('border-red-400', 'border-green-400');
            return;
        }

        if (value.length !== 12) {
            feedback.textContent = `Please enter 12 digits. Current length: ${value.length} digits`;
            feedback.classList.remove('hidden');
            feedback.classList.remove('text-green-400');
            feedback.classList.add('text-red-400');
            input.classList.add('border-red-400');
            input.classList.remove('border-green-400');
        } else {
            feedback.textContent = 'Valid Aadhar number format';
            feedback.classList.remove('hidden');
            feedback.classList.remove('text-red-400');
            feedback.classList.add('text-green-400');
            input.classList.remove('border-red-400');
            input.classList.add('border-green-400');
        }
    }

    function validateMobile(input) {
        const feedback = document.getElementById('mobileFeedback');
        const value = input.value.replace(/\D/g, ''); // Remove non-digits
        input.value = value; // Update input to show only digits

        if (value.length === 0) {
            feedback.classList.add('hidden');
            input.classList.remove('border-red-400', 'border-green-400');
            return;
        }

        if (value.length !== 10) {
            feedback.textContent = `Please enter 10 digits. Current length: ${value.length} digits`;
            feedback.classList.remove('hidden');
            feedback.classList.remove('text-green-400');
            feedback.classList.add('text-red-400');
            input.classList.add('border-red-400');
            input.classList.remove('border-green-400');
        } else {
            feedback.textContent = 'Valid mobile number format';
            feedback.classList.remove('hidden');
            feedback.classList.remove('text-red-400');
            feedback.classList.add('text-green-400');
            input.classList.remove('border-red-400');
            input.classList.add('border-green-400');
        }
    }

    let aadharTimeout;

    document.getElementById('aadharNumber').addEventListener('input', function(e) {
        const aadharInput = e.target;
        const feedback = document.getElementById('aadharFeedback');
        
        // Clear previous timeout
        clearTimeout(aadharTimeout);
        
        // Clear feedback if input is empty
        if (!aadharInput.value) {
            feedback.textContent = '';
            feedback.className = 'absolute mt-1 text-sm';
            return;
        }

        // Validate format first
        if (!/^\d*$/.test(aadharInput.value)) {
            feedback.textContent = 'Only numbers are allowed';
            feedback.className = 'absolute mt-1 text-sm text-red-400';
            return;
        }

        // Check if length is 12
        if (aadharInput.value.length === 12) {
            // Set timeout for API call
            aadharTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/profiles/check-aadhar?aadharNumber=${aadharInput.value}`);
                    const data = await response.json();
                    
                    if (data.exists) {
                        feedback.textContent = 'This Aadhar number is already registered';
                        feedback.className = 'absolute mt-1 text-sm text-red-400';
                        aadharInput.setCustomValidity('This Aadhar number is already registered');
                    } else {
                        feedback.textContent = 'Aadhar number is available';
                        feedback.className = 'absolute mt-1 text-sm text-green-400';
                        aadharInput.setCustomValidity('');
                    }
                } catch (error) {
                    console.error('Error checking Aadhar:', error);
                    feedback.textContent = 'Error checking Aadhar number';
                    feedback.className = 'absolute mt-1 text-sm text-red-400';
                }
            }, 500); // 500ms delay to prevent too many requests
        } else {
            feedback.textContent = 'Aadhar number must be 12 digits';
            feedback.className = 'absolute mt-1 text-sm text-yellow-400';
            aadharInput.setCustomValidity('Aadhar number must be 12 digits');
        }
    });
</script>
